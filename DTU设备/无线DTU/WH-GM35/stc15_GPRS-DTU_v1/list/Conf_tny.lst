A51 MACRO ASSEMBLER  CONF_TNY                                                             01/07/2019 14:17:51 PAGE     1


MACRO ASSEMBLER A51 V8.02
OBJECT MODULE PLACED IN .\list\Conf_tny.obj
ASSEMBLER INVOKED BY: D:\Program Files (x86)\Keil\C51\BIN\A51.EXE Conf_tny.A51 SET(LARGE) DEBUG PRINT(.\list\Conf_tny.ls
                      t) XREF OBJECT(.\list\Conf_tny.obj) EP

LOC  OBJ            LINE     SOURCE

                       1     $nomod51 
                       2     ;------------------------------------------------------------------------------
                       3     ;  This file is part of the RTX-51 TINY  Real-Time Operating System Package
                       4     ;  Copyright KEIL ELEKTRONIK GmbH and Keil Software, Inc. 1991-2002
                       5     ;  Version 2.01
                       6     ;------------------------------------------------------------------------------
                       7     ;  CONF_TNY.A51:  This code allows the configuration of the
                       8     ;                 RTX-51 TINY Real-Time Operating System
                       9     ;
                      10     ;  Copy this file to your project folder and add the copy to your uVision2
                      11     ;  project.  You can customize several parameters of RTX51 Tiny within this
                      12     ;  configuration file.
                      13     ;
                      14     ;  If you use command line tools, translate this file with:
                      15     ;
                      16     ;     Ax51 CONF_TNY.A51
                      17     ;
                      18     ;  If you use command line tools, link the modified CONF_TNY.OBJ file to 
                      19     ;  your application with:
                      20     ;
                      21     ;     Lx51 <your object file list>, CONF_TNY.OBJ <controls>
                      22     ;
                      23     ;------------------------------------------------------------------------------
                      24     ;
                      25     ;  RTX-51 TINY Hardware-Timer
                      26     ;  ==========================
                      27     ;
                      28     ;  With the following EQU statements the initialization of the RTX-51 TINY
                      29     ;  Hardware-Timer can be defined (RTX-51 TINY uses the 8051 Timer 0 for 
                      30     ;  controlling RTX-51 software timers).
                      31     ;
                      32     ;  Define the register bank used for the timer interrupt.
  0001                33     INT_REGBANK     EQU     1       ; default is Registerbank 1
                      34     ;
                      35     ;  Define Hardware-Timer tick time in 8051 machine cycles.
  2710                36     INT_CLOCK       EQU     10000   ; default is 10000 cycles
                      37     ;
                      38     ;  Define Round-Robin Timeout in Hardware-Timer ticks.
  0005                39     TIMESHARING     EQU     5       ; default is 5 Hardware-Timer ticks.
                      40     ;                               ; 0 disables Round-Robin Task Switching
                      41     ;
                      42     ;  Long User Interrupt Routines: set to 1 if your application contains 
                      43     ;  user interrupt functions that may take longer than a hardware timer 
                      44     ;  interval for execution.
  0001                45     LONG_USR_INTR   EQU     1       ; 0 user interrupts execute fast.
                      46     ;                       ; 1 user interrupts take long execution times.
                      47     ;
                      48     ;
                      49     ;------------------------------------------------------------------------------
                      50     ;
                      51     ;  USER CODE FOR 8051 HARDWARE TIMER INTERRUPT
                      52     ;  ===========================================
                      53     ;
                      54     ;  The following macro defines the code executed on a hardware timer interrupt.
                      55     ;
                      56     ;  Define instructions executed on a hardware timer interrupt.
                      57     HW_TIMER_CODE   MACRO
A51 MACRO ASSEMBLER  CONF_TNY                                                             01/07/2019 14:17:51 PAGE     2

                      58                                     ; Empty Macro by default
                      59                     RETI
                      60                     ENDM
                      61     ;
                      62     ;
                      63     ;------------------------------------------------------------------------------
                      64     ;
                      65     ;  CODE BANKING SUPPORT
                      66     ;  ====================
                      67     ;
                      68     ;  The following EQU statement controls the code banking support for RTX51 TINY.
                      69     ;
                      70     ;  Enable or disable code banking support
  0000                71     CODE_BANKING     EQU     0      ; 0 (default) application uses no code banking
                      72     ;                               ; 1 application uses code banking
                      73     ;
                      74     ;------------------------------------------------------------------------------
                      75     ;
                      76     ;  RTX-51 TINY Stack Space
                      77     ;  =======================
                      78     ;
                      79     ;  The following EQU statements defines the size of the internal RAM used
                      80     ;  for stack area and the minimum free space on the stack.  A macro defines
                      81     ;  the code executed when there is there is not enough free stack on the
                      82     ;  CPU stack.
                      83     ;
                      84     ;  Define the highest RAM address used for CPU stack
  00FF                85     RAMTOP          EQU     0FFH    ; default is address (256-1)
                      86     ;
  0014                87     FREE_STACK      EQU     20      ; default is 20 bytes free space on stack
                      88     ;                               ; the value 0 disables stack checking
                      89     ;
                      90     STACK_ERROR     MACRO
                      91                     CLR     EA      ; disable interrupts
                      92                     SJMP    $       ; endless loop if stack space is exhausted
                      93                     ENDM
                      94     ;
                      95     ;
                      96     ;------------------------------------------------------------------------------
                      97     ;
                      98     ;  8051 CPU IDLE CODE
                      99     ;  ==================
                     100     ;
                     101     ;  Many 8051 devices provide an IDLE MODE that reduces power consumption and
                     102     ;  EMC.  The following macro defines the code executed when there is no 
                     103     ;  ready task in the system.  The code must set the CPU into an IDLE MODE
                     104     ;  that stops instruction execution until an 8051 hardware interrupt occurs. 
                     105     ;
                     106     
                     107     ; Disable or Enable CPU_IDLE CODE
  0001               108     CPU_IDLE_CODE   EQU     1       ; 0  CPU_IDLE MACRO is not inserted
                     109                                     ; 1  CPU_IDLE MACRO is executed
                     110     
  0087               111     PCON            DATA    087H    ; Power Control SFR on most 8051 devices
                     112     
                     113     ; Stop CPU execution until hardware interrupt; executed when there is no 
                     114     ; active task in the system. 
                     115     CPU_IDLE        MACRO
                     116                     ORL     PCON,#1 ; set 8051 CPU to IDLE
                     117                     ENDM
                     118     ;
                     119     ;
                     120     ;------------------------------------------------------------------------------
                     121     ;----------------- !!! End of User Configuration Part    !!! ------------------
                     122     ;----------------- !!! Do not modify code sections below !!! ------------------
                     123     ;------------------------------------------------------------------------------
A51 MACRO ASSEMBLER  CONF_TNY                                                             01/07/2019 14:17:51 PAGE     3

                     124     
                     125     ; SFR Symbols
  00D0               126     PSW     DATA    0D0H
  00E0               127     ACC     DATA    0E0H
  00F0               128     B       DATA    0F0H
  0081               129     SP      DATA    81H
  0082               130     DPL     DATA    82H
  0083               131     DPH     DATA    83H
  0088               132     TCON    DATA    88H
  0089               133     TMOD    DATA    89H
  008A               134     TL0     DATA    8AH
  008B               135     TL1     DATA    8BH
  008C               136     TH0     DATA    8CH
  008D               137     TH1     DATA    8DH
  00A8               138     IE      DATA    0A8H
                     139     
                     140     ; TCON
  008F               141     TF1     BIT     8FH
  008E               142     TR1     BIT     8EH
  008D               143     TF0     BIT     8DH
  008C               144     TR0     BIT     8CH
  008B               145     IE1     BIT     8BH
  008A               146     IT1     BIT     8AH
  0089               147     IE0     BIT     89H
  0088               148     IT0     BIT     88H
                     149     ; IE 
  00AF               150     EA      BIT     0AFH
  00AC               151     ES      BIT     0ACH
  00AB               152     ET1     BIT     0ABH
  00AA               153     EX1     BIT     0AAH
  00A9               154     ET0     BIT     0A9H
  00A8               155     EX0     BIT     0A8H
                     156     
                     157     ; Check Configuration Values
                     158     
                     159     
                     160                     NAME    ?RTX51_TINY_KERNAL
                     161     
                     162     PUBLIC  ?RTX_CURRENTTASK 
                     163     PUBLIC  ?RTX_RAMTOP
                     164     PUBLIC  os_switch_task
                     165     PUBLIC  ?RTX?SET_ISR
                     166     
                     167     EXTRN   NUMBER (?RTX_MAXTASKN)          ; max Task Number
                     168     
  00FF               169     ?RTX_RAMTOP       EQU   RAMTOP
  D8F0               170     ?RTX_CLOCK        EQU   -INT_CLOCK
                     171     
  0008               172     ?RTX_REGISTERBANK EQU   INT_REGBANK * 8
----                 173                       DSEG  AT    ?RTX_REGISTERBANK
0008                 174                       DS    2     ; temporary space
000A                 175     ?RTX_SAVEACC:     DS    1
  REG                176     saveacc           EQU   R2    ; for access in interrupt service routine
000B                 177     ?RTX_SAVEPSW:     DS    1
  REG                178     savepsw           EQU   R3    ; for access in interrupt service routine
000C                 179     ?RTX_CURRENTTASK: DS    1
  REG                180     currenttask       EQU   R4    ; for access in interrupt service routine
                     181     
                     182     IF (TIMESHARING <> 0)
000D                 183     ?RTX_ROBINTIME:   DS    1
  REG                184     robintime         EQU   R5    ; for access in interrupt service routine
                     185     ENDIF
                     186     
                     187     IF (CODE_BANKING <> 0)
                             EXTRN   DATA    (?B_CURRENTBANK)
                             EXTRN   CODE    (?B_RESTORE_BANK)
A51 MACRO ASSEMBLER  CONF_TNY                                                             01/07/2019 14:17:51 PAGE     4

                             ENDIF
                     191     
                     192     
                     193     ;------------------------------------------------
                     194     ; Table of Task Entry Pointers
                     195     ;------------------------------------------------
                     196     PUBLIC  ?RTX_TASKENTRY
                     197     
                     198     ?RTX?TASKENT?S  SEGMENT CODE
----                 199                     RSEG    ?RTX?TASKENT?S
0000                 200     ?RTX_TASKENTRY: DS      2
                     201     
                     202     ;------------------------------------------------
                     203     ; Table of Stack Pointers for each task
                     204     ;------------------------------------------------
                     205     PUBLIC  ?RTX_TASKSP
                     206     
                     207     ?RTX?TASKSP?S   SEGMENT IDATA
----                 208                     RSEG    ?RTX?TASKSP?S
0000                 209     ?RTX_TASKSP:    DS      1
                     210     
                     211     ;------------------------------------------------
                     212     ; Table of Task Timer/State Pointers
                     213     ;------------------------------------------------
                     214     PUBLIC  ?RTX_TASKSTATUS
                     215     
                     216     ?RTX?TASKSTATE?S  SEGMENT IDATA
----                 217                       RSEG    ?RTX?TASKSTATE?S
0000                 218     ?RTX_TASKSTATUS:
0000                 219     TimerVal:       DS      1       ; Task Timer (Software Timer for each task)
0001                 220     TaskState:      DS      1       ; Task Status (state of each Task)
                     221     
                     222     ; Definitions for Bits in Task State
                     223     ;  TaskState.0  = Wait for Signal
                     224     ;  TaskState.1  = Wait for TimeOut
                     225     ;  TaskState.2  = Signal Flag
                     226     ;  TaskState.3  = TimeOut Flag
                     227     ;  TaskState.4  = Task Ready (Wait for Running)
                     228     ;  TaskState.5  = Task Active (enabled with os_create)
                     229     ;  TaskState.6  = Round Robin Time Out
                     230     ;  TaskState.7  = Run Flag
                     231     
                     232     ; byte mask definitions
  0001               233     K_SIG           EQU     1
  0002               234     K_TMO           EQU     2
  0004               235     SIG_EVENT       EQU     4
  0008               236     TMO_EVENT       EQU     8
  0010               237     K_READY         EQU     16
  0020               238     K_ACTIVE        EQU     32
  0040               239     K_ROBIN         EQU     64
  0080               240     K_IVL           EQU     128  ; not a task state bit; only used in os_wait
  0080               241     RDY_EVENT       EQU     128  ; READY status flag
  0080               242     K_RDY           EQU     128  ; READY status flag
                     243     
                     244     ; bit position definitions
  0000               245     B_WAITSIG       EQU     0
  0001               246     B_WAITTIM       EQU     1
  0002               247     B_SIGNAL        EQU     2
  0003               248     B_TIMEOUT       EQU     3
  0004               249     B_READY         EQU     4
  0005               250     B_ACTIVE        EQU     5
  0006               251     B_ROBIN         EQU     6
  0007               252     B_IVL           EQU     7    ; not a task state bit; only used in os_wait
  0007               253     B_RDY           EQU     7
                     254     
                     255     
A51 MACRO ASSEMBLER  CONF_TNY                                                             01/07/2019 14:17:51 PAGE     5

                     256     IF (TIMESHARING OR CPU_IDLE_CODE)
                     257     ?RTX?BITS       SEGMENT BIT
----                 258                     RSEG    ?RTX?BITS
                     259     ENDIF
                     260     
                     261     IF (TIMESHARING)
0000                 262     ?RTX_TS_DELAY:  DBIT    1       ; Status bit set when task switch in progress
                     263     ENDIF
                     264     
                     265     IF (CPU_IDLE_CODE)
0001                 266     ?RTX_ISR_SIG:   DBIT    1       ; Status bit set when interrupt or os_set_signal
                     267     ENDIF
                     268     
                     269     
----                 270                     CSEG    AT      0BH
000B 020000   F      271                     JMP     TIMERINT
                     272     
                     273     ?RTX?CODE       SEGMENT CODE
----                 274                     RSEG    ?RTX?CODE
                     275                     USING   0               ; Registerbank 0 for following code
                     276     
                     277     IF (FREE_STACK <> 0)
0000                 278     ?RTX_STACKERROR:
                     279                     STACK_ERROR             ; User defined Stack Error Code
                     282     ENDIF
                     283     
0004                 284     HW_TIMER:       HW_TIMER_CODE
                     287     
0005                 288     TIMERINT:
                     289     
                     290     IF (LONG_USR_INTR)
0005 C0E0            291                     PUSH    ACC
0007 E5D0            292                     MOV     A,PSW
0009 5418            293                     ANL     A,#018H
000B 6408            294                     XRL     A,#?RTX_REGISTERBANK
000D 7003            295                     JNZ     CONT_TIMINT
                     296     ; avoid recursive timer interrupt
000F D0E0            297                     POP     ACC
0011 32              298                     RETI            ; Return from Recursive Timer Interrupt
0012 D0E0            299     CONT_TIMINT:    POP     ACC
                     300     
                     301     ENDIF
                     302     
0014 120000   F      303                     CALL    HW_TIMER        ; Enable Interrupts again.
                     304     
0017 85D00B          305                     MOV     ?RTX_SAVEPSW,PSW
001A 75D008          306                     MOV     PSW,#?RTX_REGISTERBANK
001D FA              307                     MOV     saveacc,A
                     308     ; Update 8051 Interrupt Timer
001E C28C            309                     CLR     TR0
0020 E58A            310                     MOV     A,TL0
0022 24F7            311                     ADD     A,#LOW (?RTX_CLOCK + 7)
0024 F58A            312                     MOV     TL0,A
0026 E58C            313                     MOV     A,TH0
0028 34D8            314                     ADDC    A,#HIGH (?RTX_CLOCK + 7)
002A F58C            315                     MOV     TH0,A
002C D28C            316                     SETB    TR0
                     317     
                     318     IF (FREE_STACK <> 0)
                     319     ; Check if enough free stack is available
002E EC              320                     MOV     A,currenttask
002F 2400     F      321                     ADD     A,#?RTX?TASKSP?S+1
0031 F8              322                     MOV     R0,A
0032 E6              323                     MOV     A,@R0
0033 BC0002   F      324                     CJNE    currenttask,#?RTX_MAXTASKN,checkstack
0036 74FF            325                     MOV     A,#RAMTOP
A51 MACRO ASSEMBLER  CONF_TNY                                                             01/07/2019 14:17:51 PAGE     6

0038 C3              326     checkstack:     CLR     C
0039 9581            327                     SUBB    A,SP
003B B41400          328                     CJNE    A,#FREE_STACK,$+3
003E 40C0            329                     JC      ?RTX_STACKERROR
                     330     ENDIF
                     331     
                     332     ; Update & Check Task Timers
0040 7900     F      333                     MOV     R1,#?RTX_MAXTASKN+1
0042 7800     F      334                     MOV     R0,#?RTX?TASKSTATE?S
0044 16              335     TIMERLOOP:      DEC     @R0          ; Decrement timer
0045 E6              336                     MOV     A,@R0
0046 08              337                     INC     R0           ; advance to TaskState
0047 700B            338                     JNZ     NoTimeout
0049 C2AF            339                     CLR     EA
004B E6              340                     MOV     A,@R0
004C 30E103          341                     JNB     ACC.B_WAITTIM,NoWaitTimeout
004F 4418            342                     ORL     A,#(K_READY+TMO_EVENT)
0051 F6              343                     MOV     @R0,A
0052 D2AF            344     NoWaitTimeout:  SETB    EA
0054 08              345     NoTimeout:      INC     R0           ; advance to TaskTimer
0055 D9ED            346                     DJNZ    R1,TIMERLOOP
                     347     
0057 EA              348                     MOV     A,saveacc
0058 8BD0            349                     MOV     PSW,savepsw
                     350                     USING   0               ; Registerbank 0 for following code
                     351     
                     352     IF (TIMESHARING == 0)
                             ; Round Robin Task Switching not required.  System Interrupt ends here
                             ?RTX?SET_ISR:   
                             IF (CPU_IDLE_CODE)
                                             SETB    ?RTX_ISR_SIG
                             ENDIF
                                             RET     
                             ENDIF
                     360     
                     361     IF (TIMESHARING)
                     362     ; Round Robin Task Switching required.  Check if task generates timeout
                     363     ; Check for Round Robin Timeout on the current task
005A 300003   F      364                     JNB     ?RTX_TS_DELAY,CheckRobinTime
005D                 365     NoRobinTimeout: 
005D                 366     ?RTX?SET_ISR:   
                     367     IF (CPU_IDLE_CODE)
005D D200     F      368                     SETB    ?RTX_ISR_SIG
                     369     ENDIF
005F 22              370                     RET     
0060 D50DFA          371     CheckRobinTime: DJNZ     ?RTX_ROBINTIME,NoRobinTimeout
                     372     
0063                 373     ?RTX_TASKSWITCHING:
0063 C0E0            374                     PUSH    ACC
0065 C0D0            375                     PUSH    PSW
0067 C0F0            376                     PUSH    B
0069 C083            377                     PUSH    DPH
006B C082            378                     PUSH    DPL
006D C000            379                     PUSH    AR0
006F C001            380                     PUSH    AR1
0071 C002            381                     PUSH    AR2
0073 C003            382                     PUSH    AR3
0075 C004            383                     PUSH    AR4
0077 C005            384                     PUSH    AR5
0079 C006            385                     PUSH    AR6
007B C007            386                     PUSH    AR7
                     387     IF (CODE_BANKING <> 0)
                                             PUSH    ?B_CURRENTBANK
                             ENDIF
                     390     
007D E50C            391                     MOV     A,?RTX_CURRENTTASK
A51 MACRO ASSEMBLER  CONF_TNY                                                             01/07/2019 14:17:51 PAGE     7

007F 23              392                     RL      A
0080 2400     F      393                     ADD     A,#?RTX?TASKSTATE?S+1
0082 F8              394                     MOV     R0,A
0083 7440            395                     MOV     A,#K_ROBIN
0085 C2AF            396                     CLR     EA
0087 46              397                     ORL     A,@R0
0088 F6              398                     MOV     @R0,A
0089 D2AF            399                     SETB    EA
                     400     IF (CODE_BANKING <> 0)
                                             SJMP    os_switch_task1
                             ENDIF
                     403     ENDIF
                     404     
                     405     ;------------------------------------------------
                     406     ; Perform a Task-Switch
                     407     ;  void os_switch_task (void)
                     408     ;      uchar i;
                     409     ;      uchar limit;
                     410     
                     411     ;---- Variable 'current' assigned to Register 'R6' ----
                     412     ;---- Variable 'next' assigned to Register 'R7' ----
                     413     ;---- Variable 'i' assigned to Register 'R0' ----
                     414     ;---- Variable 'limit' assigned to Register 'R5' ----
                     415     ;
                     416     ;------------------------------------------------
                     417     
008B                 418     os_switch_task:
                     419     
                     420     IF (CODE_BANKING <> 0)
                                             PUSH    ?B_CURRENTBANK
                             ENDIF
                     423     
008B                 424     os_switch_task1:
                     425     
                     426     ;      next = current;
                     427     IF (TIMESHARING <> 0)
008B D200     F      428                     SETB    ?RTX_TS_DELAY           ; Delay Task Switching
                     429     ENDIF
008D E50C            430                     MOV     A,?RTX_CURRENTTASK
008F FF              431                     MOV     R7,A
                     432     ;      while (1)  {
0090 23              433                     RL      A
0091 2400     F      434                     ADD     A,#?RTX?TASKSTATE?S+1
0093 F8              435                     MOV     R0,A
0094                 436     ?C0001:
                     437     ;        if (++next == MAXTASKN+1)  next = 0;
0094 0F              438                     INC     R7
0095 08              439                     INC     R0
0096 08              440                     INC     R0
                     441     IF (CPU_IDLE_CODE)
0097 EF              442                     MOV     A,R7
0098 B50C06          443                     CJNE    A,?RTX_CURRENTTASK,NoIDLE
009B 100003   F      444                     JBC     ?RTX_ISR_SIG,NoIDLE
                     445                     CPU_IDLE          ; CPU sleep
00A1                 447     NoIDLE:
                     448     ENDIF
00A1 BF0004   F      449                     CJNE    R7,#?RTX_MAXTASKN+1,?C0003
00A4 7F00            450                     MOV     R7,#0
00A6 7800     F      451                     MOV     R0,#?RTX?TASKSTATE?S+1
00A8                 452     ?C0003:
                     453     ;        if (STATE[next].st & K_READY)  break;
00A8 E6              454                     MOV     A,@R0
00A9 30E4E8          455                     JNB     ACC.B_READY,?C0001
                     456     ;      }
                     457     ;
                     458     
A51 MACRO ASSEMBLER  CONF_TNY                                                             01/07/2019 14:17:51 PAGE     8

                     459     PUBLIC  ?RTX_NEXTID
                     460     PUBLIC  ?RTX_NEXTTASK
                     461     
  0007               462     ?RTX_NEXTID     EQU     AR7
00AC 00              463     ?RTX_NEXTTASK:  NOP             ; for Debugging
                     464     
                     465     ;      while (current < next)  {
00AD                 466     ?C0005:
00AD E50C            467                     MOV     A,?RTX_CURRENTTASK
00AF C3              468                     CLR     C
00B0 9F              469                     SUBB    A,R7
00B1 5020            470                     JNC     ?C0011
                     471     
                     472     ;        current++;
00B3 050C            473                     INC     ?RTX_CURRENTTASK
                     474     ;        i = STKP[current];
00B5 7400     F      475                     MOV     A,#?RTX?TASKSP?S
00B7 250C            476                     ADD     A,?RTX_CURRENTTASK
00B9 F8              477                     MOV     R0,A
00BA E6              478                     MOV     A,@R0
00BB FD              479                     MOV     R5,A
                     480     ;        STKP[current] = SP;
00BC A681            481                     MOV     @R0,SP
                     482     ;        if (current == MAXTASKN) limit = RAMTOP;
00BE 08              483                     INC     R0
00BF E6              484                     MOV     A,@R0
00C0 AE0C            485                     MOV     R6,?RTX_CURRENTTASK
00C2 BE0002   F      486                     CJNE    R6,#?RTX_MAXTASKN,?C0007
00C5 74FF            487                     MOV     A,#RAMTOP
00C7                 488     ?C0007:
00C7 CD              489                     XCH     A,R5
00C8 F8              490                     MOV     R0,A
                     491     ;        else                       limit = STKP[current+1];
                     492     ;
                     493     ;        while (i != limit)  {
00C9                 494     ?C0009:
00C9 E8              495                     MOV     A,R0
00CA 6D              496                     XRL     A,R5
00CB 60E0            497                     JZ      ?C0005
                     498     ;          SP++;
                     499     ;          i++;
                     500     ;          STACK[SP] = STACK[i];
00CD 08              501                     INC     R0
00CE E6              502                     MOV     A,@R0
00CF C0E0            503                     PUSH    ACC
00D1 80F6            504                     SJMP    ?C0009
                     505     ;        }
                     506     ;      }
00D3                 507     ?C0011:
                     508     ;
                     509     ;      while (current > next)  {
00D3 E50C            510                     MOV     A,?RTX_CURRENTTASK
00D5 D3              511                     SETB    C
00D6 9F              512                     SUBB    A,R7
00D7 4027            513                     JC      ?C0012
                     514             
00D9 E50C            515                     MOV     A,?RTX_CURRENTTASK
00DB 2400     F      516                     ADD     A,#?RTX?TASKSP?S+1
00DD F8              517                     MOV     R0,A
00DE E6              518                     MOV     A,@R0
                     519     ;        if (current == (MAXTASKN)) i = RAMTOP;
                     520     ;        else                       i = STKP[current+1];
00DF AE0C            521                     MOV     R6,?RTX_CURRENTTASK
00E1 BE0002   F      522                     CJNE    R6,#?RTX_MAXTASKN,?C0013
00E4 74FF            523                     MOV     A,#RAMTOP
00E6                 524     ?C0013:
A51 MACRO ASSEMBLER  CONF_TNY                                                             01/07/2019 14:17:51 PAGE     9

00E6 FD              525                     MOV     R5,A
                     526     ;        limit = STKP[current];
00E7 18              527                     DEC     R0
00E8 E6              528                     MOV     A,@R0
00E9 CD              529                     XCH     A,R5
00EA F8              530                     MOV     R0,A
                     531     ;
                     532     ;        while (SP != limit)  {
00EB                 533     ?C0015:
00EB E581            534                     MOV     A,SP
00ED 6D              535                     XRL     A,R5
00EE 6006            536                     JZ      ?C0016
                     537     ;          STACK[i] = STACK[SP];
                     538     ;          i--;
                     539     ;          SP--;
00F0 D0E0            540                     POP     ACC
00F2 F6              541                     MOV     @R0,A
00F3 18              542                     DEC     R0
                     543     
00F4 80F5            544                     SJMP    ?C0015
00F6                 545     ?C0016:
                     546     ;        }
                     547     ;        STKP[current] = i;
00F6 E50C            548                     MOV     A,?RTX_CURRENTTASK
00F8 2400     F      549                     ADD     A,#?RTX?TASKSP?S
00FA C8              550                     XCH     A,R0
00FB F6              551                     MOV     @R0,A
                     552     ;        current--;
00FC 150C            553                     DEC     ?RTX_CURRENTTASK
00FE 80D3            554                     SJMP    ?C0011
0100                 555     ?C0012:
                     556     ;      }
                     557     
                     558     ;      RoundRobinTime = ?RTX_TIMESHARING
                     559     IF (TIMESHARING)
0100 750D05          560                     MOV     ?RTX_ROBINTIME,#TIMESHARING
                     561     ENDIF
                     562              
                     563     ;       if (STATE[current].st & K_ROBIN)  goto RobinOn;
0103 E50C            564                     MOV     A,?RTX_CURRENTTASK
0105 23              565                     RL      A
0106 2400     F      566                     ADD     A,#?RTX?TASKSTATE?S+1
0108 F8              567                     MOV     R0,A
0109 7F04            568                     MOV     R7,#SIG_EVENT
010B C2AF            569                     CLR     EA
010D E6              570                     MOV     A,@R0
                     571     IF (TIMESHARING)
010E 10E61E          572                     JBC     ACC.B_ROBIN,RobinOn
                     573     ENDIF
                     574     ;       if ((STATE[current].st & K_SIG) && (STATE[current].st & SIG_EVENT)
                     575     ;          goto SignalOn;
0111 30E003          576                     JNB     ACC.B_WAITSIG,SignalOff
0114 10E20C          577                     JBC     ACC.B_SIGNAL,SignalOn
0117                 578     SignalOff:
                     579     ;       if ((STATE[current].st & K_TMO) && (STATE[current].st & TMO_EVENT)
                     580     ;          goto TimeOutOn;
0117 7F00            581                     MOV     R7,#0           ; No Event
0119 30E107          582                     JNB     ACC.B_WAITTIM,NoEvent
011C 30E304          583                     JNB     ACC.B_TIMEOUT,NoEvent
011F                 584     TimeOutOn:      
011F 7F08            585                     MOV     R7,#TMO_EVENT
0121 54F4            586                     ANL     A,#0F4H
0123                 587     SignalOn:
0123 C2E7            588     NoEvent:        CLR     ACC.B_RDY       ; Clear RDY bit
0125 C6              589                     XCH     A,@R0
0126 D2AF            590                     SETB    EA
A51 MACRO ASSEMBLER  CONF_TNY                                                             01/07/2019 14:17:51 PAGE    10

                     591     
0128 5480            592                     ANL     A,#K_RDY
012A 4207            593                     ORL     AR7,A
                     594     IF (TIMESHARING <> 0)
                     595       IF (CODE_BANKING)
                                             POP     ACC
                                             CALL    ?B_RESTORE_BANK
                               ENDIF
012C C200     F      599                     CLR     ?RTX_TS_DELAY
012E 22              600                     RET
                     601     ELSE
                               IF (CODE_BANKING)
                                             POP     ACC
                                             JMP     ?B_RESTORE_BANK
                               ENDIF
                                             RET
                             ENDIF
                     608                     
                     609                     
                     610     
                     611     ;------------------------------------------------
                     612     IF (TIMESHARING <> 0)
012F F6              613     RobinOn:        MOV     @R0,A
0130 D2AF            614                     SETB    EA
                     615     IF (CODE_BANKING)
                                             POP     ACC
                                             CALL    ?B_RESTORE_BANK
                             ENDIF
0132 D007            619                     POP     AR7
0134 D006            620                     POP     AR6
0136 D005            621                     POP     AR5
0138 D004            622                     POP     AR4
013A D003            623                     POP     AR3
013C D002            624                     POP     AR2
013E D001            625                     POP     AR1
0140 D000            626                     POP     AR0
0142 D082            627                     POP     DPL
0144 D083            628                     POP     DPH
0146 D0F0            629                     POP     B
0148 D0D0            630                     POP     PSW
014A D0E0            631                     POP     ACC
014C C200     F      632                     CLR     ?RTX_TS_DELAY
014E 22              633                     RET                     ; Restart Task
                     634     ENDIF
                     635     ;    }
                     636     ;  }
                     637     
                     638     
                     639     
                     640     ;------------------------------------------------
                     641     ; Start RTX-51 Tiny Kernel
                     642     ;------------------------------------------------
                     643     
                     644     EXTRN CODE (?C_STARTUP)
                     645     PUBLIC  main
                     646     
014F 7800     F      647     main:           MOV     R0,#?RTX?TASKSP?S
0151 A681            648                     MOV     @R0,SP
0153 7400     F      649                     MOV     A,#?RTX_MAXTASKN
0155 6006            650                     JZ      main2
0157 FF              651                     MOV     R7,A
0158 08              652     main1:          INC     R0
0159 76FF            653                     MOV     @R0,#RAMTOP
015B DFFB            654                     DJNZ    R7,main1
015D 7F00     F      655     main2:          MOV     R7,#?RTX_MAXTASKN+1
015F E4              656                     CLR     A
A51 MACRO ASSEMBLER  CONF_TNY                                                             01/07/2019 14:17:51 PAGE    11

0160 7800     F      657                     MOV     R0,#?RTX?TASKSTATE?S
0162 F6              658     main1x:         MOV     @R0,A
0163 08              659                     INC     R0
0164 F6              660                     MOV     @R0,A
0165 08              661                     INC     R0
0166 DFFA            662                     DJNZ    R7,main1x
0168 7800     F      663                     MOV     R0,#?RTX?TASKSTATE?S+1
016A 7630            664                     MOV     @R0,#K_ACTIVE+K_READY
016C 900000   F      665                     MOV     DPTR,#?RTX?TASKENT?S
016F 7401            666                     MOV     A,#1
0171 93              667                     MOVC    A,@A+DPTR
0172 C0E0            668                     PUSH    ACC
0174 E4              669                     CLR     A
0175 93              670                     MOVC    A,@A+DPTR
0176 C0E0            671                     PUSH    ACC
                     672     IF (TIMESHARING <> 0)
0178 750D05          673                     MOV     ?RTX_ROBINTIME,#TIMESHARING
                     674     ENDIF
017B 438901          675                     ORL     TMOD,#01H       ; Timer 0 Mode 1
017E 758AF0          676                     MOV     TL0,#LOW (?RTX_CLOCK)
0181 758CD8          677                     MOV     TH0,#HIGH (?RTX_CLOCK)
0184 D28C            678                     SETB    TR0
0186 D2AF            679                     SETB    EA
0188 D2A9            680                     SETB    ET0
018A 22              681                     RET             ; Start Task 0
                     682     
                     683     
                     684     ;------------------------------------------------
                     685     
                     686     PUBLIC ?RTX_TASKIDX
018B 00       F      687     ?RTX_TASKIDX:   DB      ?RTX_MAXTASKN           ; for Debugging
                     688     
                     689                     END
A51 MACRO ASSEMBLER  CONF_TNY                                                             01/07/2019 14:17:51 PAGE    12

XREF SYMBOL TABLE LISTING
---- ------ ----- -------


N A M E             T Y P E  V A L U E   ATTRIBUTES / REFERENCES

?C0001 . . . . . .  C ADDR   0094H   R   SEG=?RTX?CODE   436# 455
?C0003 . . . . . .  C ADDR   00A8H   R   SEG=?RTX?CODE   449 452#
?C0005 . . . . . .  C ADDR   00ADH   R   SEG=?RTX?CODE   466# 497
?C0007 . . . . . .  C ADDR   00C7H   R   SEG=?RTX?CODE   486 488#
?C0009 . . . . . .  C ADDR   00C9H   R   SEG=?RTX?CODE   494# 504
?C0011 . . . . . .  C ADDR   00D3H   R   SEG=?RTX?CODE   470 507# 554
?C0012 . . . . . .  C ADDR   0100H   R   SEG=?RTX?CODE   513 555#
?C0013 . . . . . .  C ADDR   00E6H   R   SEG=?RTX?CODE   522 524#
?C0015 . . . . . .  C ADDR   00EBH   R   SEG=?RTX?CODE   533# 544
?C0016 . . . . . .  C ADDR   00F6H   R   SEG=?RTX?CODE   536 545#
?C_STARTUP . . . .  C ADDR   -----       EXT   644#
?RTX51_TINY_KERNAL  N NUMB   -----          160
?RTX?BITS. . . . .  B SEG    0002H       REL=UNIT   257# 258
?RTX?CODE. . . . .  C SEG    018CH       REL=UNIT   273# 274
?RTX?SET_ISR . . .  C ADDR   005DH   R   SEG=?RTX?CODE   165 366#
?RTX?TASKENT?S . .  C SEG    0002H       REL=UNIT   198# 199 665
?RTX?TASKSP?S. . .  I SEG    0001H       REL=UNIT   207# 208 321 475 516 549 647
?RTX?TASKSTATE?S .  I SEG    0002H       REL=UNIT   216# 217 334 393 434 451 566 657 663
?RTX_CLOCK . . . .  N NUMB   D8F0H   A      170# 311 314 676 677
?RTX_CURRENTTASK .  D ADDR   000CH   A      162 179# 391 430 443 467 473 476 485 510 515 521 548 553 564
?RTX_ISR_SIG . . .  B ADDR   0000H.1 R   SEG=?RTX?BITS   266# 368 444
?RTX_MAXTASKN. . .  N ADDR   -----       EXT   167# 324 333 449 486 522 649 655 687
?RTX_NEXTID. . . .  D ADDR   0007H   A      459 462#
?RTX_NEXTTASK. . .  C ADDR   00ACH   R   SEG=?RTX?CODE   460 463#
?RTX_RAMTOP. . . .  N NUMB   00FFH   A      163 169#
?RTX_REGISTERBANK.  N NUMB   0008H   A      172# 173 294 306
?RTX_ROBINTIME . .  D ADDR   000DH   A      183# 371 560 673
?RTX_SAVEACC . . .  D ADDR   000AH   A      175#
?RTX_SAVEPSW . . .  D ADDR   000BH   A      177# 305
?RTX_STACKERROR. .  C ADDR   0000H   R   SEG=?RTX?CODE   278# 329
?RTX_TASKENTRY . .  C ADDR   0000H   R   SEG=?RTX?TASKENT?S   196 200#
?RTX_TASKIDX . . .  C ADDR   018BH   R   SEG=?RTX?CODE   686 687#
?RTX_TASKSP. . . .  I ADDR   0000H   R   SEG=?RTX?TASKSP?S   205 209#
?RTX_TASKSTATUS. .  I ADDR   0000H   R   SEG=?RTX?TASKSTATE?S   214 218#
?RTX_TASKSWITCHING  C ADDR   0063H   R   SEG=?RTX?CODE   373#
?RTX_TS_DELAY. . .  B ADDR   0000H.0 R   SEG=?RTX?BITS   262# 364 428 599 632
ACC. . . . . . . .  D ADDR   00E0H   A      127# 291 297 299 341 374 455 503 540 572 576 577 582 583 588 631 668 671
AR0. . . . . . . .  D ADDR   0000H   A      379 626
AR1. . . . . . . .  D ADDR   0001H   A      380 625
AR2. . . . . . . .  D ADDR   0002H   A      381 624
AR3. . . . . . . .  D ADDR   0003H   A      382 623
AR4. . . . . . . .  D ADDR   0004H   A      383 622
AR5. . . . . . . .  D ADDR   0005H   A      384 621
AR6. . . . . . . .  D ADDR   0006H   A      385 620
AR7. . . . . . . .  D ADDR   0007H   A      386 462 593 619
B. . . . . . . . .  D ADDR   00F0H   A      128# 376 629
B_ACTIVE . . . . .  N NUMB   0005H   A      250#
B_IVL. . . . . . .  N NUMB   0007H   A      252#
B_RDY. . . . . . .  N NUMB   0007H   A      253# 588
B_READY. . . . . .  N NUMB   0004H   A      249# 455
B_ROBIN. . . . . .  N NUMB   0006H   A      251# 572
B_SIGNAL . . . . .  N NUMB   0002H   A      247# 577
B_TIMEOUT. . . . .  N NUMB   0003H   A      248# 583
B_WAITSIG. . . . .  N NUMB   0000H   A      245# 576
B_WAITTIM. . . . .  N NUMB   0001H   A      246# 341 582
CHECKROBINTIME . .  C ADDR   0060H   R   SEG=?RTX?CODE   364 371#
CHECKSTACK . . . .  C ADDR   0038H   R   SEG=?RTX?CODE   324 326#
CODE_BANKING . . .  N NUMB   0000H   A      71# 187 387 400 420 595 602 615
CONT_TIMINT. . . .  C ADDR   0012H   R   SEG=?RTX?CODE   295 299#
CPU_IDLE_CODE. . .  N NUMB   0001H   A      108# 256 265 355 367 441
A51 MACRO ASSEMBLER  CONF_TNY                                                             01/07/2019 14:17:51 PAGE    13

CURRENTTASK. . . .    REG    R4             180#
DPH. . . . . . . .  D ADDR   0083H   A      131# 377 628
DPL. . . . . . . .  D ADDR   0082H   A      130# 378 627
EA . . . . . . . .  B ADDR   00A8H.7 A      150# 280 339 344 396 399 569 590 614 679
ES . . . . . . . .  B ADDR   00A8H.4 A      151#
ET0. . . . . . . .  B ADDR   00A8H.1 A      154# 680
ET1. . . . . . . .  B ADDR   00A8H.3 A      152#
EX0. . . . . . . .  B ADDR   00A8H.0 A      155#
EX1. . . . . . . .  B ADDR   00A8H.2 A      153#
FREE_STACK . . . .  N NUMB   0014H   A      87# 277 318 328
HW_TIMER . . . . .  C ADDR   0004H   R   SEG=?RTX?CODE   284# 303
IE . . . . . . . .  D ADDR   00A8H   A      138#
IE0. . . . . . . .  B ADDR   0088H.1 A      147#
IE1. . . . . . . .  B ADDR   0088H.3 A      145#
INT_CLOCK. . . . .  N NUMB   2710H   A      36# 170
INT_REGBANK. . . .  N NUMB   0001H   A      33# 172
IT0. . . . . . . .  B ADDR   0088H.0 A      148#
IT1. . . . . . . .  B ADDR   0088H.2 A      146#
K_ACTIVE . . . . .  N NUMB   0020H   A      238# 664
K_IVL. . . . . . .  N NUMB   0080H   A      240#
K_RDY. . . . . . .  N NUMB   0080H   A      242# 592
K_READY. . . . . .  N NUMB   0010H   A      237# 342 664
K_ROBIN. . . . . .  N NUMB   0040H   A      239# 395
K_SIG. . . . . . .  N NUMB   0001H   A      233#
K_TMO. . . . . . .  N NUMB   0002H   A      234#
LONG_USR_INTR. . .  N NUMB   0001H   A      45# 290
MAIN . . . . . . .  C ADDR   014FH   R   SEG=?RTX?CODE   645 647#
MAIN1. . . . . . .  C ADDR   0158H   R   SEG=?RTX?CODE   652# 654
MAIN1X . . . . . .  C ADDR   0162H   R   SEG=?RTX?CODE   658# 662
MAIN2. . . . . . .  C ADDR   015DH   R   SEG=?RTX?CODE   650 655#
NOEVENT. . . . . .  C ADDR   0123H   R   SEG=?RTX?CODE   582 583 588#
NOIDLE . . . . . .  C ADDR   00A1H   R   SEG=?RTX?CODE   443 444 447#
NOROBINTIMEOUT . .  C ADDR   005DH   R   SEG=?RTX?CODE   365# 371
NOTIMEOUT. . . . .  C ADDR   0054H   R   SEG=?RTX?CODE   338 345#
NOWAITTIMEOUT. . .  C ADDR   0052H   R   SEG=?RTX?CODE   341 344#
OS_SWITCH_TASK . .  C ADDR   008BH   R   SEG=?RTX?CODE   164 418#
OS_SWITCH_TASK1. .  C ADDR   008BH   R   SEG=?RTX?CODE   424#
PCON . . . . . . .  D ADDR   0087H   A      111# 446
PSW. . . . . . . .  D ADDR   00D0H   A      126# 292 305 306 349 375 630
RAMTOP . . . . . .  N NUMB   00FFH   A      85# 169 325 487 523 653
RDY_EVENT. . . . .  N NUMB   0080H   A      241#
ROBINON. . . . . .  C ADDR   012FH   R   SEG=?RTX?CODE   572 613#
ROBINTIME. . . . .    REG    R5             184#
SAVEACC. . . . . .    REG    R2             176#
SAVEPSW. . . . . .    REG    R3             178#
SIGNALOFF. . . . .  C ADDR   0117H   R   SEG=?RTX?CODE   576 578#
SIGNALON . . . . .  C ADDR   0123H   R   SEG=?RTX?CODE   577 587#
SIG_EVENT. . . . .  N NUMB   0004H   A      235# 568
SP . . . . . . . .  D ADDR   0081H   A      129# 327 481 534 648
TASKSTATE. . . . .  I ADDR   0001H   R   SEG=?RTX?TASKSTATE?S   220#
TCON . . . . . . .  D ADDR   0088H   A      132#
TF0. . . . . . . .  B ADDR   0088H.5 A      143#
TF1. . . . . . . .  B ADDR   0088H.7 A      141#
TH0. . . . . . . .  D ADDR   008CH   A      136# 313 315 677
TH1. . . . . . . .  D ADDR   008DH   A      137#
TIMEOUTON. . . . .  C ADDR   011FH   R   SEG=?RTX?CODE   584#
TIMERINT . . . . .  C ADDR   0005H   R   SEG=?RTX?CODE   271 288#
TIMERLOOP. . . . .  C ADDR   0044H   R   SEG=?RTX?CODE   335# 346
TIMERVAL . . . . .  I ADDR   0000H   R   SEG=?RTX?TASKSTATE?S   219#
TIMESHARING. . . .  N NUMB   0005H   A      39# 182 256 261 352 361 427 559 560 571 594 612 672 673
TL0. . . . . . . .  D ADDR   008AH   A      134# 310 312 676
TL1. . . . . . . .  D ADDR   008BH   A      135#
TMOD . . . . . . .  D ADDR   0089H   A      133# 675
TMO_EVENT. . . . .  N NUMB   0008H   A      236# 342 585
TR0. . . . . . . .  B ADDR   0088H.4 A      144# 309 316 678
TR1. . . . . . . .  B ADDR   0088H.6 A      142#
A51 MACRO ASSEMBLER  CONF_TNY                                                             01/07/2019 14:17:51 PAGE    14



REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
